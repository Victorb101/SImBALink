% Generate a motor parameter file (MOTOR_NAME.mat) for the Motor.slx model.
% 

% REQUIREMENTS
%	A raw motor data set must have:
%	-	Motor flux linkage calibration data (see phi_m_cal_source, below)
%	-	"calculate_efficiency.m", a function that returns motor efficiency
%		map breakpoints
%	-	"<motorname>_const_parameters.m", a script that assigns variables
%		corresponding to "constant" motor parameters
%	-	"<motorname>_signals.m", a script that creates the Simulink.Signal
%		objects corresponding to the signals in the model

clear;
clc;

% Motor datafile info string. This is the only way people know what the
% hell the output file is!
info = 'EMRAX 228HV motor parameter data - Dec 2014';

% The name of the data set to use for calibration (should be a folder in
% the "Raw" directory).
motor	= 'EMRAX_228HV';
output	= fullfile('..', 'Configurations', [ motor '.mat']);
path(motor, path)

%% Load constant parameters
run( [ motor '_const_parameters.m' ] );

%% Load motor signals
run( [ motor '_signals.m' ] );

%% Calculate efficiency
eta		=	calculate_efficiency();

%% Write to file (prelim)
save( output,	...
	'info',		...
	'eta',		...
	'Ld',		...
	'Lq',		...
	'R',		...
	'eta_m',	...
	'Pwaste',	...
	'Vs'		...
);

%% Calculate motor flux linkage
phi_m	= calculate_fluxlinkage();

%% Write to file (final)
save( output,	...
	'info',		...
	'eta',		...
	'phi_m',	...
	'Ld',		...
	'Lq',		...
	'R',		...
	'eta_m',	...
	'Pwaste',	...
	'Vs'		...
);
